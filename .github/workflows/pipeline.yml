# GitHub Actions – Jurimetria ETL
# Atualiza diariamente (03 h UTC) ou manualmente via botão *Run workflow*
# Mantém dois conectores (legacy) e a pipeline principal de múltiplos TJs.

name: Atualiza Jurimetria → GPT

on:
  workflow_dispatch:
  schedule:
    - cron: '0 3 * * *'   # ≅ 00:00 BRT

jobs:
  build-upload:
    runs-on: ubuntu-latest

    # ➜ expõe a chave de API do DataJud/ESAJ ao script
    env:
      CNJ_API_KEY: ${{ secrets.CNJ_API_KEY }}

    steps:
      # Clona o repositório
      - uses: actions/checkout@v4

      # Instala Python + dependências (cache‑pip ❤)
      - name: Setup Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      # ─────────────────────────────────────────────
      # Conector e‑SAJ (scraping TJCE / outros ESAJ)
      # Sub‑comando «esaj» OBRIGATÓRIO ➟ corrige erro «invalid choice»
      - name: Executa connector ESAJ
        run: |
          python legacy/legacy_datajud_connector.py esaj \
            --classe "Apelação Cível" \
            --data-inicio $(date -d "365 days ago" +'%F') \
            --data-fim $(date +'%F') \
            --save artifacts/esaj_decisoes_latest.json

      # Conector DataJud (estatísticas CNJ)
      # Sub‑comando «datajud» OBRIGATÓRIO
      - name: Executa connector DataJud
        run: |
          python legacy/legacy_datajud_connector.py datajud \
            --classe "Apelação Cível" \
            --ano $(date +'%Y') \
            --save artifacts/datajud_stats_latest.json

      # Pipeline oficial – coleta multiplica TJs (TJCE padrão + outros)
      - name: Executa jurimetria_pipeline (TJCE,TJSP,TJRS de exemplo)
        run: |
          python src/jurimetria_pipeline.py TJCE TJSP TJRS

      # Faz upload dos artefatos para inspeção / etapas seguintes
      - name: Upload para GPT
        uses: actions/upload-artifact@v4
        with:
          name: dados_jurimetria
          path: |
            artifacts/*.json
            dados_jurimetria/**
