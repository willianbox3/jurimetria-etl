# GitHub ActionsÂ â€“ Jurimetria ETL
# Atualiza diariamente (03Â hÂ UTC) ou manualmente via botÃ£o *Run workflow*
# MantÃ©m dois conectoresÂ (legacy) e a pipeline principal de mÃºltiplosÂ TJs.

name: AtualizaÂ JurimetriaÂ â†’Â GPT

on:
  workflow_dispatch:
  schedule:
    - cron: '0 3 * * *'   # â‰…Â 00:00â€¯BRT

jobs:
  build-upload:
    runs-on: ubuntu-latest

    # âœ expÃµe a chave de API do DataJud/ESAJ ao script
    env:
      CNJ_API_KEY: ${{ secrets.CNJ_API_KEY }}

    steps:
      # Clona o repositÃ³rio
      - uses: actions/checkout@v4

      # Instala Python + dependÃªncias (cacheâ€‘pip â¤)
      - name: Setup Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ğŸ§ª Run tests
        run: |
          pytest -q

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # ConectorÂ eâ€‘SAJÂ (scraping TJCE / outrosÂ ESAJ)
      # Subâ€‘comando Â«esajÂ» OBRIGATÃ“RIO âŸ corrige erro Â«invalid choiceÂ»
      - name: Executa connector ESAJ
        run: |
          python legacy/legacy_datajud_connector.py esaj \
            --classe "ApelaÃ§Ã£o CÃ­vel" \
            --data-inicio $(date -d "365 days ago" +'%F') \
            --data-fim $(date +'%F') \
            --save artifacts/esaj_decisoes_latest.json

      # ConectorÂ DataJud (estatÃ­sticas CNJ)
      # Subâ€‘comando Â«datajudÂ» OBRIGATÃ“RIO
      - name: Executa connector DataJud
        run: |
          python legacy/legacy_datajud_connector.py datajud \
            --classe "ApelaÃ§Ã£o CÃ­vel" \
            --ano $(date +'%Y') \
            --save artifacts/datajud_stats_latest.json

      # Pipeline oficial â€“ coleta multiplica TJs (TJCE padrÃ£o + outros)
      - name: Executa jurimetria_pipeline (TJCE,TJSP,TJRS de exemplo)
        run: |
          python src/jurimetria_pipeline.py TJCE TJSP TJRS

      # Faz upload dos artefatos para inspeÃ§Ã£o / etapas seguintes
      - name: Upload para GPT
        uses: actions/upload-artifact@v4
        with:
          name: dados_jurimetria
          path: |
            artifacts/*.json
            dados_jurimetria/**
