name: Atualiza Jurimetria → GPT

on:
  # roda todos os dias às 03 h UTC (00 h BRT) **e** quando você clicar em *Run workflow*
  schedule:
    - cron: '0 3 * * *'
  workflow_dispatch:

jobs:
  build-upload:
    runs-on: ubuntu-latest

    # injeta a chave da API declarada em *Settings → Secrets → Actions*
    env:
      CNJ_API_KEY: ${{ secrets.CNJ_API_KEY }}

    steps:
      # 1) Clona o repositório
      - uses: actions/checkout@v4

      # 2) Instala dependências
      - name: Instala dependências
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      # 3) Executa o conector **e-SAJ** (subcomando `esaj`)
      - name: Executa conector e-SAJ
        run: |
          python legacy_datajud_connector.py esaj \
            --classe "Apelação Cível" \
            --data-inicio $(date -d "365 days ago" +%F) \
            --data-fim   $(date +%F) \
            --save artifacts/esaj_decisoes_latest.json

      # 4) Executa o conector **DataJud** (subcomando `datajud`)
      - name: Executa conector DataJud
        run: |
          python legacy_datajud_connector.py datajud \
            --classe "Apelação Cível" \
            --ano $(date +%Y) \
            --save artifacts/datajud_stats_latest.json

      # 5) Faz upload dos artefatos gerados
      - name: Upload para GPT
        uses: actions/upload-artifact@v4
        with:
          name: jurimetria-dados
          path: artifacts/
